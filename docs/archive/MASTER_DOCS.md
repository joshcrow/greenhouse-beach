# **The Greenhouse Gazette: Master Documentation**

**System:** The Greenhouse Gazette **Version:** 2.1 (Refined Architecture) **Status:** Active Development

## **PART 1: PRODUCT REQUIREMENTS DOCUMENT (PRD)**

### **1\. Executive Summary**

**Vision:** Transform passive greenhouse monitoring into an active, narrative-driven experience. **Core Value Proposition:** An autonomous "Headless Publishing Engine" utilizing distributed Edge AI to ingest environmental metrics and imagery, generating a daily status newsletter with a "Witty, Scientific, Optimistic" persona.

### **2\. System Architecture (Distributed Edge)**

#### **2.1 Hardware Layers**

**Node A: The Gateway (Mission Critical)**

* **Hardware:** Raspberry Pi 4 (4GB) \+ UPS HAT.  
* **Role:** IoT Wireless Access Point, MQTT Broker, NTP Server (Stratum 1), NAT Gateway.  
* **Resilience:** Hardware Watchdog enabled.  
* **Environmental:** Conformal coating (silicone/acrylic) on PCB. Mating surfaces masked, external seals greased.

**Node B: The Storyteller (Compute/Storage)**

* **Hardware:** Raspberry Pi 5 (8GB) \+ NVMe Base \+ 1TB SSD \+ UPS HAT.  
* **Role:** Ingestion API, Narrative Engine (LLM), Video Rendering, Historical DB.  
* **Connectivity:** Gigabit Ethernet to Home Router.  
* **Cooling:** Active cooling required (Target ambient tolerance \>30°C).

**Node C/D: The Satellites (Telemetry/Vision)**

* **Hardware:** Raspberry Pi Zero 2 W.  
* **Role:** Stateless capture endpoints.  
* **Power:**  
  * Interior: Grid USB-C.  
  * Exterior: 50W Solar Panel \+ 20Ah LiFePO4 Battery \+ MPPT Controller.  
* **Storage:** OverlayFS (Read-Only) enabled permanently.

#### **2.2 Network Topology (Split-Horizon with NAT)**

**Zone 1: IoT Secure (10.0.0.0/24)**

* **Host:** Node A (wlan0 \- AP Mode).  
* **Clients:** Nodes C/D.  
* **Services:** DHCP, NTP (10.0.0.1), MQTT (10.0.0.1:1883).  
* **Routing:** Node A provides DNAT (Port Forwarding) for port 5000 \-\> Node B IP.

**Zone 2: Home Network (192.168.1.0/24)**

* **Clients:** Node A (eth0 or wlan1), Node B (eth0).  
* **Access:** Dashboard access for end-users.

### **3\. Functional Requirements**

#### **Epic 1: Device Registry & Config**

* **REQ-1.1:** registry.json on Node B defines the "Truth." Includes mac\_address, device\_type, topic\_root, and personality\_context.  
* **REQ-1.2:** Node B pushes configuration updates to Node A via MQTT retained messages.

#### **Epic 2: Visual Intelligence Pipeline ("Push-and-Verify")**

* **REQ-2.1:** Satellites capture to RAM (/tmp or similar tmpfs).  
* **REQ-2.2:** Satellites POST to http://10.0.0.1:5000 (Node A forwards to Node B).  
* **REQ-2.3:** Node B responds 200 OK only after checksum verification.  
* **REQ-2.4 (Curation):** Node B rejects images with Luminance \<10% or \>95%. Object detection flags "Car" or "Human" for privacy rejection.

#### **Epic 3: Narrative Engine**

* **REQ-3.1 (Sanitization):** Sensor data inputs clamped: Temp (-10°F to 130°F), Humidity (0% to 100%). Outliers marked NULL.  
* **REQ-3.2 (Prompt Engineering):** System prompt includes current registry context to prevent hallucinating non-existent sensors.  
* **REQ-3.3 (Safety):** Checksum validation on all "Fact" statements generated by AI against raw SQL data.

#### **Epic 4: Power & Maintenance**

* **REQ-5.1:** Node B halts ffmpeg rendering if UPS battery \< 30%.  
* **REQ-5.2 (Storage Janitor):** Maintain \< 85% disk usage. Delete incoming first, then transcode archive video to HEVC (H.265) to save space.

## **PART 2: TECHNICAL SPECIFICATION**

### **1\. Directory Structure (Node B)**

`/opt/greenhouse/`  
`├── docker-compose.yml`  
`├── .env                        # API_KEY, MQTT_USER, MQTT_PASS, SECRET_KEY`  
`├── configs/`  
`│   ├── registry.json           # Master Device List`  
`│   └── prometheus.yml          # Metrics config`  
`├── data/`  
`│   ├── incoming/               # RAM Disk or fast scratchpad`  
`│   ├── archive/                # YYYY/MM/DD structure`  
`│   └── db/                     # InfluxDB (Time series), SQLite (Metadata)`  
`└── scripts/`  
    `├── api/                    # FastAPI app (ingestion)`  
    `├── core/                   # Curator, Narrator, Publisher classes`  
    `└── maintenance/            # Janitor and Watchdog scripts`

### **2\. Satellite Logic (courier.py)**

**State Machine:**

1. **Boot:** Mount / as Read-Only.  
2. **Network Wait:** Loop check for Gateway IP (10.0.0.1).  
3. **Time Sync:** chronyd \-q 'server 10.0.0.1 iburst'. **Critical:** Fail hard if time sync fails (prevents log drifting).  
4. **Capture:** libcamera-still to RAM buffer.  
5. **Transport:**  
   * POST to Gateway.  
   * Timeout: 10s.  
   * On Fail: Exponential backoff (up to 5 mins).  
   * On Success: Flush buffer.

### **3\. Docker Composition (Node B)**

`version: '3.8'`  
`services:`  
  `mqtt_broker:`  
    `image: eclipse-mosquitto`  
    `ports: ["1883:1883"]`  
    `volumes:`  
      `- ./configs/mosquitto:/mosquitto/config`

  `storyteller_api:`  
    `build: ./scripts/api`  
    `restart: always`  
    `ports: ["5000:5000"]`  
    `environment:`  
      `- DB_PATH=/app/data/db/greenhouse.db`  
    `volumes:`  
      `- ./data:/app/data`

  `narrator_engine:`  
    `build: ./scripts/core`  
    `restart: unless-stopped`  
    `depends_on:`  
      `- storyteller_api`  
    `environment:`  
      `- AI_MODEL=gemini-1.5-flash`  
    `volumes:`  
      `- ./data:/app/data`

  `dashboard:`  
    `image: nginx:alpine`  
    `volumes:`  
      `- ./data/www:/usr/share/nginx/html:ro`

### **4\. Hardware/OS Configuration**

* **Node A (Gateway) Routing:**  
  * Enable IPv4 forwarding in sysctl.conf.  
  * iptables \-t nat \-A PREROUTING \-i wlan0 \-p tcp \--dport 5000 \-j DNAT \--to-destination 192.168.1.50:5000 (assuming Node B static IP).  
  * iptables \-t nat \-A POSTROUTING \-o eth0 \-j MASQUERADE.

## **PART 3: QA & OPERATIONS**

### **1\. Chaos Engineering**

| Test ID | Name | Action | Success Criteria |
| :---- | :---- | :---- | :---- |
| **CHAOS-01** | **The Blackout** | Cut mains power to Node B. | UPS signals shutdown via NUT (Network UPS Tools). FS unmounts cleanly. |
| **CHAOS-02** | **Route Failure** | Node B unreachable from Node A. | Satellites cache up to 50MB locally in RAM, then overwrite oldest. |
| **CHAOS-03** | **Time Warp** | Reboot Satellite without WAN. | Satellite syncs time from Node A (10.0.0.1) and dates photo correctly. |

### **2\. Maintenance SOPs**

**SOP-01: Satellite Patching (OverlayFS)**

1. **Status:** Read-Only by default.  
2. **Unlock:** sudo raspi-config nonint do\_overlayfs 1 \-\> Reboot.  
3. **Patch:** git pull.  
4. **Lock:** sudo raspi-config nonint do\_overlayfs 0 \-\> Reboot.

**SOP-02: Node A Network Bridge Recovery** If wlan0 (IoT AP) fails to start via hostapd:

1. Connect via eth0 (Home LAN).  
2. Check logs: journalctl \-u hostapd \-u dnsmasq.  
3. Emergency Reset: Exec script emergency\_net\_reset.sh (flushes iptables, restarts services).

# **The Greenhouse Gazette: Epics & User Stories**

**Target System:** The Greenhouse Gazette v2.1 (Hardened) **Context:** Distributed IoT Edge System (Raspberry Pi 4/5/Zero 2 W) **Primary Actor:** "The System" (Autonomous) **Secondary Actor:** "The Gardener" (Human User)

## **Epic 1: Extensible Device Registry & Configuration**

**Goal:** Establish a single source of truth for all hardware nodes, sensors, and personalities that dictates system behavior at runtime without code changes.

### **Story 1.1: Registry Schema Definition**

**As a** Developer, **I want** a strict JSON schema for registry.json, **So that** the system can validate device capabilities and personalities at startup.

* **Technical Tasks:**  
  * Create Pydantic models for Device, Sensor, and Personality.  
  * Implement registry.json loader with validation logic in config\_loader.py.  
  * Define fields: mac\_address (PK), ip\_address, type (camera/sensor), location, topic\_root, active (bool).  
* **Acceptance Criteria:**  
  * System crashes intentionally on startup if registry.json is malformed.  
  * Registry supports adding a new device without modifying Python code.

### **Story 1.2: Config Propagation (Node B \-\> Node A)**

**As** Node A (Gateway), **I want** to receive configuration updates from Node B, **So that** I know which MQTT topics to subscribe to and bridge.

* **Technical Tasks:**  
  * Implement a "Config Publisher" on Node B that posts hashed registry updates to greenhouse/config/announce.  
  * Node A subscribes to updates and reloads mosquitto bridge config if topology changes.  
* **Acceptance Criteria:**  
  * Node A logs acknowledgment of config update.  
  * Updates are sent as Retained Messages in MQTT.

## **Epic 2: Visual Intelligence Pipeline ("The Eyes")**

**Goal:** Reliably capture, transport, and curate high-definition imagery from low-power satellites to the central core, respecting energy budgets.

### **Story 2.1: The "Courier" Protocol (Satellite Logic)**

**As a** Solar-Powered Satellite (Node C/D), **I want** to check my battery health *before* attempting network activity, **So that** I do not cause a brownout loop or damage the LiFePO4 cells.

* **Technical Tasks:**  
  * **Pre-flight Check:** Read ADC (battery voltage).  
    * If V \< 3.2V: Enter Deep Sleep (1 hour). Do not boot WiFi.  
  * **Network Wait:** Enable WiFi. Loop check for Gateway IP (10.0.0.1).  
  * **Time Sync:** while not synced: wait() (Retry loop, max 60s). Do *not* exit process if Gateway is rebooting; sleep and retry.  
  * **Capture:** libcamera-still to RAM buffer (/tmp).  
  * **Telemetry Injection:** Read RSSI and Battery V again. Add as HTTP Headers (X-Sat-Volts, X-Sat-RSSI).  
  * **Transport:** POST to Gateway.  
* **Acceptance Criteria:**  
  * Satellite never attempts WiFi boot if voltage is critical.  
  * Satellite tolerates up to 60 seconds of Gateway downtime (NTP failure) before aborting cleanly.

### **Story 2.2: The "Gatekeeper" API (Node B Ingestion)**

**As** Node B (Storyteller), **I want** to receive images and their metadata headers, **So that** I can track satellite health alongside the photos.

6. **Technical Tasks:**  
   * Update FastAPI endpoint POST /upload to parse X-Sat-Volts and X-Sat-RSSI.  
   * Log telemetry to InfluxDB immediately.  
   * Save image to /data/incoming/{device\_id}\_{timestamp}.jpg.  
7. **Acceptance Criteria:**  
   * API returns 400 if image integrity check fails (magic bytes).  
   * Telemetry data is persisted even if the image is later rejected by Curation.

### **Story 2.3: Automated Curation (Hero Selection)**

**As** the Narrative Engine, **I want** to score incoming images, **So that** I categorize "Night" images correctly without deleting forensic data.

* **Technical Tasks:**  
  * **Luminance Check:** Calculate average pixel brightness.  
    * \< 10%: Tag as NIGHT\_MODE. Do *not* delete (Proof of safety/no fire).  
    * \> 95%: Tag as EXPOSURE\_ERR.  
  * **Object Detection:** Run lightweight YOLO/MobileNet.  
    * class \== person OR class \== car \-\> DELETE immediately (Privacy).  
    * class \== plant \-\> Score \+10.  
* **Acceptance Criteria:**  
  * Pitch black images are retained in archive but flagged so they are not selected as the "Hero" image for the morning email.  
  * Privacy deletion is absolute and logged.

## **Epic 3: The Narrative Engine ("The Brain")**

**Goal:** Synthesize raw data into human-readable, engaging content.

### **Story 3.1: Sensor Data Sanitization**

**As** the AI Processor, **I want** to clean sensor data before generating text, **So that** I don't write stories about impossible temperatures.

* **Technical Tasks:**  
  * Implement Sanitizer class.  
  * Hard limits: Temp (-10°F to 130°F), Humidity (0-100%).  
  * Replace out-of-bounds values with null or ERR.  
* **Acceptance Criteria:**  
  * A reading of 200°F is replaced with SENSOR\_FAULT.  
  * AI prompt receives SENSOR\_FAULT token, not the raw number.

### **Story 3.2: Context-Aware Prompt Construction**

**As** the System, **I want** to dynamically build the LLM system prompt, **So that** the AI knows who it is and what sensors exist today.

* **Technical Tasks:**  
  * Load personality\_context from Registry ("Witty, Scientific").  
  * Inject recent weather history (Last 3 hours trend).  
  * Inject "Hero Image" tags and satellite telemetry (e.g., "Satellite A is low on battery").  
* **Acceptance Criteria:**  
  * Generated text references specific trends ("Temperatures are rising fast").  
  * System Prompt explicitly forbids hallucinating sensors not in the Registry.

## **Epic 4: Publishing & Distribution**

**Goal:** Deliver the finalized artifact to the end-user.

### **Story 4.1: The Daily Dispatch (Email)**

**As a** User, **I want** an HTML email at 7:00 AM, **So that** I can see the greenhouse status with my morning coffee.

* **Technical Tasks:**  
  * Use Jinja2 templates for HTML layout.  
  * Embed "Hero Image" (CID embedding).  
  * Include "Vitals Card" (Max/Min/Avg tables).  
  * Include "Satellite Status" footer (Battery/Signal levels).  
* **Acceptance Criteria:**  
  * Email renders correctly on Mobile (iOS Mail).  
  * If "Hero" image is NIGHT\_MODE (no day shots available), use fallback graphic.

### **Story 4.2: Local Dashboard**

**As a** User, **I want** to view live stats on a local website, **So that** I can check real-time status without waiting for an email.

* **Technical Tasks:**  
  * Nginx serving static HTML/JS from /data/www.  
  * Node B generates status.json every 5 minutes.  
* **Acceptance Criteria:**  
  * Dashboard loads within 200ms on local LAN.  
  * Shows "System Offline" visual indicator if status.json is \> 10 mins old.

## **Epic 5: Resilience & Maintenance ("The Immune System")**

**Goal:** Ensure the system survives power loss, network partitions, and hardware aging.

### **Story 5.1: The Storage Janitor**

**As** Node B, **I want** to manage my own disk space, **So that** I never run out of storage and crash the OS.

* **Technical Tasks:**  
  * Run janitor.py hourly.  
  * Check df \-h on /data.  
  * **Rule:** If usage \> 85%, delete oldest files in incoming.  
  * **Rule:** If usage \> 90%, compress archive videos to low-bitrate.  
* **Acceptance Criteria:**  
  * System maintains at least 15% free space at all times.  
  * Logs record exactly what was deleted to preserve space.

### **Story 5.2: Power-Loss Safe Shutdown**

**As** Node B, **I want** to detect when the UPS is draining, **So that** I can stop writing to disk and shut down safely.

* **Technical Tasks:**  
  * Monitor UPS I2C/USB interface via NUT or custom script.  
  * If Battery \< 30%: Stop Docker containers (Prevent DB writes).  
  * If Battery \< 10%: Execute sudo shutdown \-h now.  
* **Acceptance Criteria:**  
  * Database file is not corrupted after a power cut simulation.  
  * System sends "Dying Breath" MQTT message before shutdown.

### **Story 5.3: Network Self-Healing (Gateway)**

**As** Node A, **I want** to restart my network interfaces gracefully if traffic stops, **So that** I don't destabilize the Stratum 1 Clock via constant reboots.

* **Technical Tasks:**  
  * Ping Node B (192.168.1.50) every 60 seconds.  
  * If fail x5: sudo systemctl restart hostapd (Restart AP).  
  * If fail x10: sudo systemctl restart networking (Flush IP stack).  
  * If fail x20: sudo reboot (Nuclear option).  
* **Acceptance Criteria:**  
  * Satellites reconnect after AP restart without requiring a Gateway hard reboot.  
  * NTP service remains active during service restarts (if possible).

