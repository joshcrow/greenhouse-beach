# =============================================================================
# SATELLITE SENSOR 2 - Greenhouse Exterior
# =============================================================================
# Hardware: FireBeetle 2 ESP32-E + BME280 + 3.7V LiPo + Solar Panel
# Location: Greenhouse exterior (production) / Josh's house (dev)
# Network:  GREENHOUSE_IOT (10.0.0.x) at Mom's, beachFi at Josh's
# 
# Features:
#   - Temperature, humidity, pressure (BME280)
#   - Battery voltage monitoring (ADC with 1/2 divider)
#   - Deep sleep (15 min cycles)
#   - Dual-network failover
#   - Maintenance mode (prevents sleep for debugging)
#   - OTA updates
#
# MQTT Topics Published:
#   greenhouse/satellite-2/sensor/satellite_2_temperature/state
#   greenhouse/satellite-2/sensor/satellite_2_humidity/state
#   greenhouse/satellite-2/sensor/satellite_2_pressure/state
#   greenhouse/satellite-2/sensor/satellite_2_battery/state
#   greenhouse/satellite-2/status (online/offline)
#
# Last Updated: 2025-12-19
# =============================================================================

esphome:
  name: satellite-sensor-2
  friendly_name: "Greenhouse Exterior Satellite"
  on_boot:
    priority: -10
    then:
      - output.turn_off: led_builtin
      
      # RESILIENT WAIT: Connect if EITHER MQTT or API is available
      - wait_until:
          timeout: 30s
          condition:
            and:
              - wifi.connected:
              - or:
                - api.connected:
                - mqtt.connected:
      - delay: 2s
      
      # MAINTENANCE CHECK (Dual-Source)
      - if:
          condition:
            or:
              - binary_sensor.is_on: maintenance_mode_ha    # Mom's House Control
              - binary_sensor.is_on: maintenance_mode_mqtt  # Dev House Control
          then:
            - logger.log: "MAINTENANCE MODE: ON. Staying awake."
            - deep_sleep.prevent: deep_sleep_1
          else:
            - logger.log: "MAINTENANCE MODE: OFF. Measuring..."
            - component.update: bme280_sensor
            - component.update: battery_voltage
            - logger.log: "Sending data..."
            - delay: 2s 
            - deep_sleep.enter: deep_sleep_1


esp32:
  board: firebeetle32
  framework:
    type: arduino


logger:
  level: DEBUG


# =============================================================================
# CONNECTIVITY
# =============================================================================

api:
  encryption:
    key: "YOUR_API_KEY_HERE"  # Generate: openssl rand -base64 32
  reboot_timeout: 0s 


mqtt:
  # PRODUCTION: Point to Greenhouse Pi (NATs to Storyteller)
  # broker: 10.0.0.1
  
  # DEV: Point to Storyteller on local network
  broker: 192.168.1.151
  
  port: 1883
  username: "greenhouse"
  password: "YOUR_MQTT_PASSWORD"
  topic_prefix: "greenhouse/satellite-2"
  discovery: false  # Prevents HA duplicates
  reboot_timeout: 0s 
  
  birth_message:
    topic: "greenhouse/satellite-2/status"
    payload: "online"
  will_message:
    topic: "greenhouse/satellite-2/status"
    payload: "offline"


ota:
  - platform: esphome
    password: "YOUR_OTA_PASSWORD"


wifi:
  power_save_mode: none
  fast_connect: false
  networks:
    # Mom's House (Production) - High Priority
    - ssid: "GREENHOUSE_IOT"
      password: "YOUR_IOT_NETWORK_PASSWORD"
      priority: 10
    
    # Josh's House (Development) - Low Priority
    - ssid: "beachFi"
      password: "YOUR_DEV_NETWORK_PASSWORD"
      priority: 5
  
  # Fallback AP for rescue/debugging
  ap:
    ssid: "Satellite-2 Rescue"
    password: "YOUR_RESCUE_AP_PASSWORD"


# =============================================================================
# HARDWARE
# =============================================================================

i2c:
  sda: 21
  scl: 22
  scan: true


output:
  - platform: gpio
    pin: 2
    id: led_builtin
    inverted: false


# =============================================================================
# SENSORS
# =============================================================================

sensor:
  - platform: bme280_i2c
    id: bme280_sensor
    address: 0x76 
    update_interval: never
    temperature:
      name: "Satellite 2 Temperature"
    pressure:
      name: "Satellite 2 Pressure"
    humidity:
      name: "Satellite 2 Humidity"

  - platform: adc
    pin: 36  # VP pin on FireBeetle
    id: battery_voltage
    name: "Satellite 2 Battery"
    update_interval: never
    attenuation: 11db
    filters:
      - multiply: 2.0  # FireBeetle has 1/2 voltage divider


# =============================================================================
# MAINTENANCE MODE
# =============================================================================

# Subscribe to MQTT maintenance topic
text_sensor:
  - platform: mqtt_subscribe
    id: mqtt_maintenance_text
    topic: "greenhouse/satellite-2/maintenance/state"
    internal: true


binary_sensor:
  # Mom's House (via Home Assistant API)
  - platform: homeassistant
    id: maintenance_mode_ha
    entity_id: input_boolean.greenhouse_satellite_2_maintenance
    internal: true 

  # Dev House (via MQTT)
  - platform: template
    id: maintenance_mode_mqtt
    name: "Maintenance Mode MQTT"
    lambda: |-
      return id(mqtt_maintenance_text).state == "ON";
    internal: true


# =============================================================================
# DEEP SLEEP
# =============================================================================

deep_sleep:
  id: deep_sleep_1
  run_duration: 60s 
  sleep_duration: 15min
